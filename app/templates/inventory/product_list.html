{% extends "base.html" %}
{% block title %}Products{% endblock %}
{% block content %}
<div class="page-header d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <h1 class="h4 mb-0"><i class="bi bi-box-seam me-2"></i>Products</h1>
  {% if current_user.is_manager_or_above() %}
  <a href="{{ url_for('inventory.product_add') }}" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg me-1"></i>Add Product</a>
  {% endif %}
</div>
{% include "includes/inventory_nav.html" %}
<form method="get" class="card p-3 mb-3">
  <div class="row g-2 align-items-end">
    <div class="col-auto"><input type="text" name="search" class="form-control form-control-sm" placeholder="Search" value="{{ search or '' }}" style="min-width: 140px;"></div>
    <div class="col-auto"><select name="category_id" class="form-select form-select-sm" style="min-width: 120px;"><option value="">All categories</option>{% for c in categories %}<option value="{{ c.id }}" {{ 'selected' if category_id == c.id else '' }}>{{ c.name }}</option>{% endfor %}</select></div>
    <div class="col-auto"><div class="form-check"><input type="checkbox" name="low_stock" value="1" class="form-check-input" id="lowStock" {{ 'checked' if low_stock else '' }}><label class="form-check-label small" for="lowStock">Low stock</label></div></div>
    <div class="col-auto"><button type="submit" class="btn btn-outline-primary btn-sm">Filter</button></div>
  </div>
</form>
<div class="card overflow-hidden">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light"><tr><th>Name</th><th>SKU</th><th>Category</th><th>Price</th><th>Qty</th><th>Min</th><th>Expiry</th>{% if current_user.is_manager_or_above() %}<th class="text-end">Actions</th>{% endif %}</tr></thead>
      <tbody>
        {% for p in pagination.items %}
        <tr class="{{ 'table-warning' if p.is_low_stock else '' }}">
          <td><strong>{{ p.name }}</strong></td>
          <td><code class="small">{{ p.sku or '-' }}</code></td>
          <td>{{ p.category.name if p.category else '-' }}</td>
          <td>{{ p.price }}</td>
          <td><span class="badge {{ 'bg-danger' if p.is_low_stock else 'bg-secondary' }}">{{ p.quantity }}</span></td>
          <td>{{ p.min_stock }}</td>
          <td>{{ p.expiration_date.strftime('%Y-%m-%d') if p.expiration_date else '-' }}</td>
          {% if current_user.is_manager_or_above() %}
          <td class="text-end">
            <a href="{{ url_for('inventory.product_edit', product_id=p.id) }}" class="btn btn-sm btn-outline-primary me-1">Edit</a>
            <form method="post" action="{{ url_for('inventory.product_delete', product_id=p.id) }}" class="d-inline" onsubmit="return confirm('Remove this product?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
            </form>
          </td>
          {% endif %}
        </tr>
        {% else %}
        <tr><td colspan="{% if current_user.is_manager_or_above() %}8{% else %}7{% endif %}" class="text-muted text-center py-4">No products found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if pagination.pages > 1 %}
  <div class="card-footer bg-transparent border-top">
    <nav><ul class="pagination pagination-sm mb-0 justify-content-center">{% for page in pagination.iter_pages() %}<li class="page-item {{ 'active' if page == pagination.page else '' }}"><a class="page-link" href="?page={{ page or 1 }}&category_id={{ category_id or '' }}&search={{ search or '' }}&low_stock={{ 1 if low_stock else 0 }}">{{ page or '...' }}</a></li>{% endfor %}</ul></nav>
  </div>
  {% endif %}
</div>
{% endblock %}
